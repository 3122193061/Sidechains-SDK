package com.horizen.datagenerator

import com.horizen.block._
import com.horizen.params.{NetworkParams, RegTestParams}
import com.horizen.utils.BytesUtils
import java.time.Instant
import com.horizen.box.ForgerBox
import com.horizen.fixtures.{CompanionsFixture, ForgerBoxFixture, MerkleTreeFixture}
import com.horizen.proof.{Signature25519, VrfProof}
import com.horizen.consensus._
import com.horizen.secret.VrfKeyGenerator
import org.junit.Test
import scorex.core.block.Block
import scorex.util.{ModifierId, bytesToId}


class sc_node_holder_fixter_settings extends CompanionsFixture {
  private val seed = 49850L

  @Test
  def generate_scGenesisBlockHex(): Unit = {
    val parentId: ModifierId = bytesToId(new Array[Byte](32))
    //val timestamp = 1574077098L
    val timestamp = Instant.now.getEpochSecond

    // Genesis MC block hex created in regtest by STF mc_blocks_data.py test on 26.01.2022
    // related data: see examples/simpleapp/src/main/resources/sc_settings.conf
    // ScTxCumCommTreeHash: "3e6a006e1c81fa15bd035f238be8d4eb482d78267e8243ce4098cf3cdf91a935"
    val mcBlockHex: String = "03000000d0747d4374943a0fc98cf222cb0de9a9e9eb137441c8e578f525e2638c8da502a09dc81bce4d6699ea05f4cbbe54b8fb78a59a18528c90d741392cb0dadd68b812cede89e516f2bca9e042c49a7a6e2946ec0b4020f5ceff470de960c7c22d17652df161f70e0f2020002454a0cb1c2cf89f82564926c3db3336eb8b0672c46ef7eccddc771e000024029a5e761165cd335225dfd67194bf2141010ef1f9ffd23c50eeb930a519f7d6662f23ee0201000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0502a4010101ffffffff04df2eb42c000000001976a914a4de35ce5a905c5845d2a169e771986111cbae8088ac80b2e60e0000000017a914ea81ee2d877a25c7530a33fcf5a65c72f681250f87405973070000000017a914e7d25d82be231cf77ab8aecb80b6066923819ffc87405973070000000017a914ca76beb25c5f1c29c305a2b3e71a2de5fe1d2eed8700000000fcffffff0ea7b41d0f9579c78528267fafbfc4165aa5ec31e3df1c67e8ff946b4900ee6843000000006b483045022100bbe4297cd67810c99de82a1fcbe2a6cb748e8f69fe29bec521ef7ad79a151cea022064198959c542623ddba006c4690a96ace56c49518fa03e07e9de8dfc9c1f485f01210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffff43991cbe25c2d3dc06d7ec036d284e703a29049fa4ae7bf7e0d3274a1b43f2e0000000006a473044022050f333ade5c90b03e50184b13caa6edee4fb60031f4fe2f08f9e27f6a731deba02207ec81e9a70573ffeab59a34600332e99e221d8a9bd0c5df48db4b773e450d50c01210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffff440bb418fd032b366c6f1735f884da34314f309d6443a890f5b84950bde41a90000000006a473044022059b958730dabeda1e30769e53169c96eb6b1b711336f01e5062d9adf3d36893f02206d60c30bbc2a73c23b28143c03fcf053cac253765d74e335e342505dec8640a701210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffff44305cc620b8c8c93407c8ae69c8b69d066cda529e554ec96d03445644b0a6d8000000006a47304402204e23ddfa137ccee4be277a2fcd7a7abc1360be11f82bfd7858b76c98118837dc0220476a35aa23e756cb871f5175e2b24ee6a66f0c12a9ff8fad9fba6d1be90827b501210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffffafab88f68ed60762a7a075884403f56688793fc274856efa36eab81f724fe15e000000006a4730440220742644804ebe1e4057d98264b4514cc9445a1658b0f72f17df9ba70ee17190ab022052522dc66804e6fb192c0b6855e2d903a5499f8ae21e7b0c46820ceb0fae7a7e01210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffff46a51ea9cb0d5c480b64c4bcc3792b012bebe85f87da7743b506b28dfe85495c000000006b483045022100e8b8224c20b5a0d0695996d7058ecca38a43e5f7a637fd0fc8f686a7a261531202207b88ce568389144c4ec774b0857b19d1e349640e6d0c0744c989046c7c84ab3e01210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffffacc9c5eb885e7706a4826ad3890867ee4afecc0d815713472d3b3ecec52d9bca000000006b4830450221009ed3954f7ebc8931f7ac460571673faa2f17b0bf9bd16054aa666ac16914fe04022000c7f808916c9815d1bf7fd65134534ab367ce2b569749121be27e054d4a874e01210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffffac7718bee2eda50e0555fa7be6f502e37e9adc234a150501f6ce0fe2dc77c4eb000000006a473044022069b70ae43027440ec04336ce0b641bf09dcfb6833be325f2c2dbb54731400e13022021eef7460dcb308dd65ab716636e33ea3263166c8ec9527fbe43aad881bef89601210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffff4b92c081fb7145c1eebbcb5cdccebd9c32af37adf46a9994961d6ca467a2f6db000000006b483045022100bfdfcab44d4b54c561c14160d4f25bfcabdfad6d4dd36e03b9db1487baed5742022019d4e3a3a1252c6f0f8da0771e29aa2be30d65f1125c0790d075b3b801237e3801210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffffb10be1a2d878726918810c2fdef3e2ae6534345a0ae5e2796fbf392fe710d656000000006a47304402204d647e63459c13e796427607b02c01d1472726994e5cf8c9c0781e605be52266022036d2a98047326786c2ccd37a5378802e117a20fca0b58f4ecd60b150961209f201210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffff4cc0ff355c7226d020252d2d4d236ee5a530c9355e264174c0cee1e72e7803e6000000006b483045022100b0c727eccccda43fc89ca8ac2de80cba9ee8345be39519c8aa06062df448449a0220666ee053971a3272e349ee5632eb442a06fd630c9a0139e3c54b40b01da1f55e01210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffff4deddabafc95f2ddfc842c6f780eca90ae3a9e433e0381d121b69d26d37a22ce000000006b483045022100a7688782e8f3a7952dac774dc5ecb948d705daf0a57a758102d2fac90905a8bd02207d8a0b54690b27430b628b0d711b104a1206fc63bbd975bcde585dd89448b12301210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffffa5487bb6e0bef395d52a2392ca3114f3bbb764a84b005a7b2158b069e8e7e444000000006a4730440220615246672f21640f7e04cad484c57a7e2629a98c57df27df1a1cdb2c08bd568902203c5bc76b5925052777f84e24a407e9d766eaebcfd8ba7f64e6ff360c92823ae601210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffffa44c6cf226c4b24a3c0466bd6485dfd90dcf944c5bdbc19d1eca135bc395819c000000006b483045022100ec4d5932ec9ad1e60bebc905789e9e6aebbb00f2ca0c249b5464763d1ca9e2c402204332fe520d9a8c257786c7361d46664982b5d0f695859fd5f70846f93ab5a95e01210236ef570797f2d3c9615f85f2d1bf38f598c229b4146d078f328c04f44cfc7366ffffffff01a14dcd1d000000003d76a914a4de35ce5a905c5845d2a169e771986111cbae8088ac2095e9e05da210af19e6d8e70eb48fe5621a0ceff8c5734b4ef36fb1270008f10d0177b400018403000000e40b5402000000acb24b2f08e8e56fe1784f1600879c697c7cd90846e076724b090fd72206b1a5219fb536dbb8cbe2283e5d466d3bf0dbed043bcbb82f6122ae72862f15d1d92b298001208a79cb0b75479f3381e009a1c14ceca91ab5ed341c2bac12dd9b2af2a60b0436fdcd0102386700000000000004000000000000003c67000000000000bfbc0100000000000c00000000000000016234e8c194d555b5ff6a082286b8241f7a1bc3d4dd71e8a88e6db8729a3de324000001c8bbcabb872abdd97870980b4020f7d6a69bd8650298c0e8984299f6ddc9eb35800001e0b56d7145dd7b006e0d9b2ea1b5bf65c26dafc33dd36fc7675eeb58ba247613800001101c1881ee4e14ce72f762869875980e3e338ce353efd0469d2d74b6254fcc0c0000015e77dbb1889b9d36cb1f345b4290894b5d27c4fea13c19ff202cbffc54d78123800001cadc641bb884c20af1d99f02c6fdb3bc837e8a436a7710252165ec6880a8d23f8000013b43af52de1e9c5e4eb52414ff12c7ec15bc499b83395dea1351640e778bf228000001c3913d5f157b058abe12eda99febaa5bf8cd3eecd768497a12112f22dc3cdd3e000001bb2e8f15c078157fbdd179843702ff55e432cac0fa60ba7459ed918f2c2df91c000001ebcda0614fa4946d2a109bd5871a10966510b9e7fa4e05d2848a4cbe49c46f1480000191aa89e90907e0c714f7c0d931dc6707d7ff2ab4e85f79769b8392d99bc95d1e000001a0877645bea04a236ec766cc0b2439c22c4c8e0fca9755ed070a1d21c4273414800001fda10c02d7a70e00000000000400000000000000dba70e000000000062951e00000000000c0000000000000008928c4e36a3e31e67a47863715990ca39b32f14e92e193012332e51446dc7a73c003a07fafc76a23266429049ca43b9f1ac2ea7baff0aedbcfa07919e2a5340b51700b3a05499134b0bbe3d012d160626b5f0fdc791899217165d626d9dc66443390100fc2bef68b8d16b76fc0feffbf3393a32286ea7e6666e8748309ef7d0b7fbef338091059fda9e88bf2a89403d20f2af347823e31ac552db4eae65575d80f3b9041380d0f38d630b0e842d0fb51b861a6c60e67a20a2764b15de6abc1e40dd33471a3d80c36dbdc6feb46adafcc2bf4c37e6107feeed32bbfe3af2a1941003302861801100bc8b436c1deadae25437f132237eff6b3a954fceef586a00260b92db5cb28f2c800008e2ffc821086f40a8662285c6ab2482c3885d2e28b20a88e23b46ff7ca20f4602809d9baf1f0152e4bc28e29afc414fcbf8304060f396063651ead6c019284f9f3800297a3a40994779a61b63eadd655b427117b05f07f47cb8d256a39d4f45fc6a3680d5ff4759f7eb5f10462028a5cbc839814be100a606b205928ffb44d0e8382012008b5c62596faa3bc1f0ca0418357a2e5e915bc2719d0fb5a56e4e16f10b2fb81280381934ff9e6add6e25c36533fe30d1f893c03d03bf16b49a33f33ad6ec2ba101803b334280c53054e41f89e35efa1a1aa1430634127b4ee9391920d1fba884f716002017d5d48c74ca40ffd95a35f6376b9acee517e03d961122dc0c7eabdfabee3b8000080699aaccf3ee0fe0d7e22ad0c215c552a5d3477ab0dbfb8378095808ca5d591d00a5619811b5f3714eae3ae0ab3d597b54a44421a98963545e0a877944ba7afc0e007f3b1abf88abecc7e3b1b808515a4d25debc2f01f7bd2915f3a4eccf3ac5993c80a9e6f2c56b2bd59484f9f3d6af5265eea2323152810cff8cc8d979fbf2ed6c29801a413354e385a6d1bc4418d363aad2973f476a1c5ae74f856d118f89735ec83c8064f084a0cdafb83c95e51b522d2a4dc24ba812b296c7589b06f4bf3029a0100a80b9a980eed407bc39e4c2fcc7a6e56d74cd9c49f7c62aca37570be118bd82af0e009f2c2ff61d0e13ba01684b7273b1db12eb44ee410bb0b02a9e87f290d79a27270000088c33b7d66769c41edcf5d773b93900744803b8cd35a16f9044540d2f544b5e1380bd68e7c8b8d4d9ca6f8a45318ffb0322f010f1c454a0112af8ae5bd02c6abd20805bf726856fc9bd383d13d870d209124c40d54665ac1bd2cf2873598999a2791680841f49e8f3d982a1e44e8992233a0708cb62067518d65bcfd634dec30f744c0080cb3ab237eee15b8d8b9f92fde2e5eece8b4b9222ab0299e4f474cde418be2f05804ad362238b7e88716c975afbd32f751109aa0a91def9e94ec59bb2510d6e8929007be79b17da6360aef1674a78ee92812462eccb1130d69e93b93652ef599f06108092e8b4331174ee76829933f35c16d1d5b340dbb92cb3972a474389ccf2ba46398000080e94b252e06b96ae885d5bfea2a18542f9b0b6e02b62fd06d3dcbe9d4f08d61280ea95c062a8809e1a0dee1fc3dbebf5062bc361a1f0d3f6a1c8d0c2680db8861d80a60167b40a86915770d8d9c9bd98ec1cdd47dbaeab8144f4d207e70d59906e2900c96a7a765f97c6cd4abb7fc547963034ab556cec065388f0371b8596450b0820808c0748b6a6f01540d735a6fdd9b153a7f4fa7b2097b562b3f2ae97b362f0bf1f00bd36e99b680050d51107020274aad1f69bbec61457204d8f1a3b44cce9130224004fdc0347aa3f8c8b7c814a709a9315e7d960fa6943e4adbeb7f6244701c1540d8049742ab2f558698eb7795c3820dcc9621cc481c18de3bcc2e3070bc9c85b9735000008dda7c1f68bd0c5ecd2a443c8a75d929c497a8d5a1876adfda969277cbe4efb0180f5358a32b1ef91f3c007052c7f17f44752cca1d52eabc1ab07a614221d2ebb070011f005fa07fe2f07a498f32e04cdf295c0850c5e14b7506112c5619062ed5c37800789cb02e14d2ac6bb58985dd5a067f12bf397f29fe691ddb972fb0bb955101c005803c20e84350e813ee8997c441172beda12692c88b2f7a5ae7a12890d2fb81c80f8ac0c8820c5bb61135fa716137ecdfa3603b696e6f750d19e501971839ccb0400ed921bce8e882f7d372ff696220259f34ef62331b4c8962b631c802418af6c3680a6a89c2a3f896e11ab184e0cd453c0a9a7e0cadff14549fc41265a16c07946000000089c8ff001a29d80c2b7e5da90dd8177f177e368f8e897a8e76adf767d655b3f158097eec429cdcf5c4aaf02bbc43a31bb2f966f132dd5e0bef525daabf03876370280cafa0fe272d5c07e76ff861e4e160b0530cff2f4fb983373dc9b455cdfb49b29001f78778a670792196261505aa25f9fd904be5cf3b0a23c9b096d1fcfcc09352180c62bce97c023486fd0cf0208c0f4d3a190b29eb1c3ef38fea456e41834def305803a35441208ce5db83ea493dfee103842179f206d19a63b5576d5ac1e75cbd815807085c7f75406c2b4821f508b4edaad9fe7386bb3da92558a23d2af64de75ac018041a7eef86c7e9bf3853bff91512e57021f2cc21e445c481f2b1b84e46ee65a10000008ed0358b6d85b0c62ce0825652825e4dc5457c7cc6ed1ff3fa80ec785cf4f090e80addd797a953af01bb934d44ac301ce50e6f4dc5d072c8b76877d59331af6fe3f809a8ad86c5967c0f3743d14b0739e0da9b2a50d9cf4b9034533c3e20414321a2a00f3d504874c0a33956f72cb46209806f30725385df0c1e63ff285fb9b0a9c2d0580112915e159801bea12d37b1c7e1d88c9dcec2f98c4498f2034a2334064c42b3a807c09f0d43909d3fc55951ef9cc9dcb48df0c0710eeff0680bfce03dfab10f908808ebc05ce77146da295b8cd1f55016c0a851192627c8f4a80dca67512553f3e0d00e803378486cb43631d05e69d19fb932d11cec6f79659f732df4907917817bf2b80000834586da86747456e176afccbed1b1eaba4077cf25e1957e84f83236393867f1a008c22e0890931f50206274af4476ed0d504742219f73f9934181b8e95c11c4b0f0087ba8cf32b0842f511d7831a02399f5708d6a9f833f65b561332dcc774130308009cf77e05cf2b3aad336dd2e27de07853480f8dd11c10851d5b608cc927bb6f2a00a3a037770c155a2f6f7beb227048d175aa378686dd1ad372e951c6d92a1c222500b53c2104263b067387ce4807e9c75d31782a12d28346c7ccbc9b288bf010410d003f6d01f346e5ca1c6f82a83dd5390f7be16bddc4721e9674f9cb64a34e82250200db9c0eda7e66e010a6892e2bafb21453ada66873603eeaeb25c66d32c6db712d8000082c26c188a30e0262c9e4eed094cfb37f8875a59c8af2f52dc4cf499d2a1e8c3d80b4ce91787794cf447c7f39a4cf30f11628aa28a1d2e4f995cb1c6e846bc6c434804ef8dc1f29028da05049835127273b42b359378baf35337626b3eff10ffbeb0c805505a32fa7100df2b8380226fed7467d0e6b0a68c184095fee1ceee4ad26da2780605e19cef403c83310bc3020be5190229ede441bd987acd2e3479b79ee53440180d62460f9624e7b0e8740a09183e9b21de2d11d3a04fc356b4724b0687b115c050071162d7becd091c543b41b9b50c3331af6f9028387e4ea2938b2b1a0a517560c001e794d111f41abfb4716105b477b7b2f6638e59dc97a19d68ec87286ef169007000008a73d62100c40ac5a9335d9113b53817c82c919d16a71763f08236586ad98d40c802700f9b126679dfea74dd3c4f7566ae3f08be4d434e815dfd43761d11198d11a000ff0558e7230d90775c7ed00d941bab15e8f5df2d2bc6c5c8db9f5b899d0f72e80007fd19cb916bcbc1ba054654c3e2ebd366869da51b39d110ede28af4d38ff2e00446902b0b27e83913a8fdd9598b9c6218f966c65dc66a90dea9c2082fa1d073900a5030daf387233bda44f6b61fc10ec58111931a9abf4f2698248a608788e793e80a49483d7b671848db3267deccabc55ed9a0a8dec3754a673a9465978784b633e80d3f077bfd46b532cf822304ce49493379a72e7fd9063cdd3619327635120d809800008916ed3f5b4bb8162c016850689e007c98277ff6d1f9599a3851553d3ede50931800a0f5569893f1133154bae7926e335eee1654028e35572fb3e1333c6d621f82c00f2b60679176ad6cd0a882c2aa831646d8fc53effee66f514127bffc094d976200010e62a4d8613da9962519bb0493c0b9e77f26cae339ed5547b181ea1a8fe7207802812eafdd5e28f8beb7a413c47f6cde17343221c549d9072f6459456491db93a00f708b2bd3352198963f4d86c429e285c39a17a9f49ec12714214e3dfa26ff613000c87d1cb8e8d0e62c015373bad3ac2a9722cd839184475d27d321b512175b42600e4238cc343935566d18425e70d9703f1c67d0ad270f99c5e53e9e6c0f577693d000002ffff00000000000000000000000000000000000000000000000000"
    val params: NetworkParams = RegTestParams(sidechainId = BytesUtils.reverseBytes(BytesUtils.fromHexString("150b139022440b354b61ecf5fdb0ea1d8a074cf73486f3a71bac34d8e3290b4a")))
    val mcRef: MainchainBlockReference = MainchainBlockReference.create(BytesUtils.fromHexString(mcBlockHex), params).get
    val mainchainBlockReferences = Seq(mcRef)
    val (forgerBox: ForgerBox, forgerMetadata)= ForgerBoxFixture.generateForgerBox(seed)
    val secretKey = VrfKeyGenerator.getInstance().generateSecret(seed.toString.getBytes)
    val publicKey = secretKey.publicImage()
    val genesisMessage =
      buildVrfMessage(intToConsensusSlotNumber(1), NonceConsensusEpochInfo(ConsensusNonce @@ "42424242".getBytes))
    val vrfProof: VrfProof = secretKey.prove(genesisMessage).getKey
    val merklePath = MerkleTreeFixture.generateRandomMerklePath(seed + 1)
    val companion = getDefaultTransactionsCompanion

    val mainchainBlockReferencesData = mainchainBlockReferences.map(_.data)
    val mainchainHeaders = mainchainBlockReferences.map(_.header)

    val sidechainTransactionsMerkleRootHash: Array[Byte] = SidechainBlock.calculateTransactionsMerkleRootHash(Seq())
    val mainchainMerkleRootHash: Array[Byte] = SidechainBlock.calculateMainchainMerkleRootHash(mainchainBlockReferencesData, mainchainHeaders)
    val ommersMerkleRootHash: Array[Byte] = SidechainBlock.calculateOmmersMerkleRootHash(Seq())

    val blockVersion: Block.Version = 1: Byte

    val unsignedBlockHeader: SidechainBlockHeader = SidechainBlockHeader(
      blockVersion,
      parentId,
      timestamp,
      forgerMetadata.forgingStakeInfo,
      merklePath,
      vrfProof,
      sidechainTransactionsMerkleRootHash,
      mainchainMerkleRootHash,
      ommersMerkleRootHash,
      0,
      new Signature25519(new Array[Byte](Signature25519.SIGNATURE_LENGTH)) // empty signature
    )

    val signature = forgerMetadata.blockSignSecret.sign(unsignedBlockHeader.messageToSign)

    val signedBlockHeader: SidechainBlockHeader = SidechainBlockHeader(
      blockVersion,
      parentId,
      timestamp,
      forgerMetadata.forgingStakeInfo,
      merklePath,
      vrfProof,
      sidechainTransactionsMerkleRootHash,
      mainchainMerkleRootHash,
      ommersMerkleRootHash,
      0,
      signature
    )

    val data = new SidechainBlock(signedBlockHeader, Seq(), mainchainBlockReferencesData, mainchainHeaders, Seq(), companion)

    val hexString = BytesUtils.toHexString(data.bytes)
    println(hexString)
  }
}
